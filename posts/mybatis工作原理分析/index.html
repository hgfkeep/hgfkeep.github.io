<!DOCTYPE html>
<html lang="zh-cn">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="heguangfu">
    <meta name="description" content="一条河流分割了过去和未来">
    <meta name="keywords" content="dev,designer">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Mybatis工作原理分析"/>
<meta name="twitter:description" content="解析配置 mybatis的配置类为 org.apache.ibatis.session.Configuration ，包括了构造 SqlSessionFactory 所需的所有参数。
 所以为了顺利的构造出 SqlSessionFactory，必须先构造 org.apache.ibatis.session.Configuration 。该配置可以通过xml解析器（mybatis内建 XMLConfigBuilder 解析处理xml配置）构造。
 MapperFactoryBean获取mapper接口代理类 `MapperFactoryBean`提供了对mapper配置文件的校验和mapper对象的生成，是mapper的工厂对象。
 1 public class MapperFactoryBean&lt;T&gt; extends SqlSessionDaoSupport implements FactoryBean&lt;T&gt;    继承了`SqlSessionDaoSupport`，该类又实现了`InitializingBean`,可知类的逻辑初始化在`afterPropertiesSet()`:
 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 //模版初始化方法 public final void afterPropertiesSet() throws IllegalArgumentException, BeanInitializationException { // 抽象父类定义检查配置 checkDaoConfig(); // 具体实现类的模版初始化方法 try { initDao(); } catch (Exception ex) { throw new BeanInitializationException(&#34;"/>

    <meta property="og:title" content="Mybatis工作原理分析" />
<meta property="og:description" content="解析配置 mybatis的配置类为 org.apache.ibatis.session.Configuration ，包括了构造 SqlSessionFactory 所需的所有参数。
 所以为了顺利的构造出 SqlSessionFactory，必须先构造 org.apache.ibatis.session.Configuration 。该配置可以通过xml解析器（mybatis内建 XMLConfigBuilder 解析处理xml配置）构造。
 MapperFactoryBean获取mapper接口代理类 `MapperFactoryBean`提供了对mapper配置文件的校验和mapper对象的生成，是mapper的工厂对象。
 1 public class MapperFactoryBean&lt;T&gt; extends SqlSessionDaoSupport implements FactoryBean&lt;T&gt;    继承了`SqlSessionDaoSupport`，该类又实现了`InitializingBean`,可知类的逻辑初始化在`afterPropertiesSet()`:
 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 //模版初始化方法 public final void afterPropertiesSet() throws IllegalArgumentException, BeanInitializationException { // 抽象父类定义检查配置 checkDaoConfig(); // 具体实现类的模版初始化方法 try { initDao(); } catch (Exception ex) { throw new BeanInitializationException(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hgfkeep.github.io/posts/mybatis%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" />
<meta property="article:published_time" content="2019-07-08T16:11:33&#43;08:00"/>
<meta property="article:modified_time" content="2019-07-08T16:11:33&#43;08:00"/>


    
      <base href="https://hgfkeep.github.io/posts/mybatis%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">
    
    <title>
  Mybatis工作原理分析 · HGFKEEP
</title>

    
      <link rel="canonical" href="https://hgfkeep.github.io/posts/mybatis%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://hgfkeep.github.io/css/coder.min.8250817d137d64c86ccdb5c74bfdfe88dab7a379d377512a5239dc149ac33dc2.css" integrity="sha256-glCBfRN9ZMhszbXHS/3&#43;iNq3o3nTd1EqUjncFJrDPcI=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="https://hgfkeep.github.io/css/code.css" />
    
      <link rel="stylesheet" href="https://hgfkeep.github.io/css/custom.css" />
    

    
    
    <link rel="icon" type="image/png" href="https://hgfkeep.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://hgfkeep.github.io/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.55.6" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://hgfkeep.github.io">
      HGFKEEP
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://hgfkeep.github.io/about/">关于</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://hgfkeep.github.io/posts/">博客</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://hgfkeep.github.io/categories/">分类</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://hgfkeep.github.io/series/">系列</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://hgfkeep.github.io/contact/">联系我</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Mybatis工作原理分析</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2019-07-08T16:11:33&#43;08:00'>
                2019-07-08
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              5 分钟阅读时间
            </span>
          </div>
          
          
        </div>
      </header>

      <div>
        <div class="sect1">
<h2 id="_解析配置"><a class="anchor" href="#_解析配置"></a>解析配置</h2>
<div class="sectionbody">
<div class="paragraph">
<p>mybatis的配置类为 <code>org.apache.ibatis.session.Configuration</code> ，包括了构造 <code>SqlSessionFactory</code> 所需的所有参数。</p>
</div>
<div class="paragraph">
<p>所以为了顺利的构造出 <code>SqlSessionFactory</code>，必须先构造 <code>org.apache.ibatis.session.Configuration</code> 。该配置可以通过xml解析器（mybatis内建 <code>XMLConfigBuilder</code> 解析处理xml配置）构造。</p>
</div>
<div class="sect2">
<h3 id="_mapperfactorybean获取mapper接口代理类"><a class="anchor" href="#_mapperfactorybean获取mapper接口代理类"></a>MapperFactoryBean获取mapper接口代理类</h3>
<div class="paragraph">
<p>`MapperFactoryBean`提供了对mapper配置文件的校验和mapper对象的生成，是mapper的工厂对象。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MapperFactoryBean</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">SqlSessionDaoSupport</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>继承了`SqlSessionDaoSupport`，该类又实现了`InitializingBean`,可知类的逻辑初始化在`afterPropertiesSet()`:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="c1">//模版初始化方法</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IllegalArgumentException</span><span class="o">,</span> <span class="nc">BeanInitializationException</span> <span class="o">{</span>
	<span class="c1">// 抽象父类定义检查配置</span>
	<span class="n">checkDaoConfig</span><span class="o">();</span>
	<span class="c1">// 具体实现类的模版初始化方法</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="n">initDao</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanInitializationException</span><span class="o">(</span><span class="s">"Initialization of DAO failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">checkDaoConfig</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">checkDaoConfig</span><span class="o">();</span>
  <span class="n">notNull</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">,</span> <span class="s">"Property 'mapperInterface' is required"</span><span class="o">);</span>
  <span class="nc">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">getSqlSession</span><span class="o">().</span><span class="na">getConfiguration</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">addToConfig</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">configuration</span><span class="o">.</span><span class="na">hasMapper</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">configuration</span><span class="o">.</span><span class="na">addMapper</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error while adding the mapper '"</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span> <span class="o">+</span> <span class="s">"' to configuration."</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="nc">ErrorContext</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">reset</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//父类验证sqlsessoin可被创建，</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">checkDaoConfig</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">notNull</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionTemplate</span><span class="o">,</span> <span class="s">"Property 'sqlSessionFactory' or 'sqlSessionTemplate' are required"</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>父类中 <code>checkDaoConfig()</code> 方法验证 SqlSession 不为空。 <code>MapperFactoryBean</code> 在设置 SqlSessionFactory 时创建 SqlSession</p>
</li>
<li>
<p><code>configuration.addMapper(this.mapperInterface);</code> 添加映射类, 保证mapper接口存在。（mapper配置存在是对配置文件解析时，自动注册的）。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>实现了`FactoryBean`接口，那么mapper对象的可以通过`getObject()`方法获得。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="no">T</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nf">getSqlSession</span><span class="o">().</span><span class="na">getMapper</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>通过SqlSession获取前面注册到配置中的接口代理类。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_构建sqlsessionfactory"><a class="anchor" href="#_构建sqlsessionfactory"></a>构建SqlSessionFactory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>一般使用`SqlSessionFactoryBean`在spring context中构造共享的`SqlSessionFactory`。</p>
</div>
<div class="paragraph">
<p><code>SqlSessionFactoryBean implements FactoryBean&lt;SqlSessionFactory&gt;, InitializingBean, ApplicationListener&lt;ApplicationEvent&gt;</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>实现了`FactoryBean`：会在bean初始化时，调用其`afterPropertiesSet()`方法进行bean的逻辑初始化；</p>
</li>
<li>
<p>实现了`InitializingBean`： 通过getBean获取的实例是此接口实现类 `getObject()`返回的实例；</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>那么重点看 <code>SqlSessionFactoryBean</code> 的 <code>afterPropertiesSet()`和 `getObject()</code> 方法。由于`getObject()`内部也是基于`afterPropertiesSet()`实现，所以重点看`afterPropertiesSet()`方法。</p>
</div>
<div class="paragraph">
<p>`afterPropertiesSet()`方法主要实现逻辑如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>解析配置：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>如果配置已经解析好，直接使用配置；</p>
</li>
<li>
<p>如果没有配置信息，但是有配置地址，那么使用`XMLConfigBuilder`解析配置；</p>
</li>
<li>
<p>否则直接生成空配置；</p>
</li>
</ol>
</div>
</li>
<li>
<p>配置别名</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>typeAliasesPackages</code>：包别名</p>
</li>
<li>
<p><code>typeAliases</code>：类别名</p>
</li>
</ol>
</div>
</li>
<li>
<p>配置插件</p>
</li>
<li>
<p>配置java类型与数据库类型的映射关系</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>typeHandler</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>配置ID生成</p>
</li>
<li>
<p>配置`DataSource`、<code>TransactionManager</code></p>
</li>
<li>
<p>解析并配置数据映射mapper</p>
</li>
<li>
<p><code>SqlSessionFactoryBuilder`使用配置构建`SqlSessionFactory</code>。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sqlsession"><a class="anchor" href="#_sqlsession"></a>SqlSession</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SqlSession 完全包含了面向数据库执行 SQL 命令所需的所有方法。你可以通过 SqlSession 实例来直接执行已映射的 SQL 语句。</p>
</div>
<div class="paragraph">
<p>通过SqlSessionFactory创建方法：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="nc">SqlSession</span> <span class="nf">openSession</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nf">openSessionFromDataSource</span><span class="o">(</span><span class="n">configuration</span><span class="o">.</span><span class="na">getDefaultExecutorType</span><span class="o">(),</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="nc">SqlSession</span> <span class="nf">openSessionFromDataSource</span><span class="o">(</span><span class="nc">ExecutorType</span> <span class="n">execType</span><span class="o">,</span> <span class="nc">TransactionIsolationLevel</span> <span class="n">level</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">autoCommit</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Environment</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getEnvironment</span><span class="o">();</span>
    <span class="kd">final</span> <span class="nc">TransactionFactory</span> <span class="n">transactionFactory</span> <span class="o">=</span> <span class="n">getTransactionFactoryFromEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">transactionFactory</span><span class="o">.</span><span class="na">newTransaction</span><span class="o">(</span><span class="n">environment</span><span class="o">.</span><span class="na">getDataSource</span><span class="o">(),</span> <span class="n">level</span><span class="o">,</span> <span class="n">autoCommit</span><span class="o">);</span>
    <span class="kd">final</span> <span class="nc">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">newExecutor</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">execType</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultSqlSession</span><span class="o">(</span><span class="n">configuration</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">autoCommit</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">closeTransaction</span><span class="o">(</span><span class="n">tx</span><span class="o">);</span> <span class="c1">// may have fetched a connection so lets call close()</span>
    <span class="k">throw</span> <span class="nc">ExceptionFactory</span><span class="o">.</span><span class="na">wrapException</span><span class="o">(</span><span class="s">"Error opening session.  Cause: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="nc">ErrorContext</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">reset</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>通过`openSession()`方法可知：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>SqlSession默认是`DefaultExecutorType`，即`SIMPLE`。`ExecutorType`包括：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>SIMPLE</code>: 每个语句创建一个`PreparedStatement`。可以返回自增主键的值（insert语句中设置`useGeneratedKeys="true"` 和 主键在类中的属性`keyProperty`）。</p>
</li>
<li>
<p><code>REUSE</code>: 重复使用`PreparedStatements`。</p>
</li>
<li>
<p><code>BATCH</code>： <strong>批量更新</strong>。</p>
</li>
</ol>
</div>
</li>
<li>
<p>事务隔离级别是`null`。</p>
</li>
<li>
<p>`autoCommit=false`事务不自动提交。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>创建的过程是：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://hgfkeep.github.io/img/mybatis工作原理分析/sqlsession构造.svg" alt="sqlsession构造">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_执行数据库操作"><a class="anchor" href="#_执行数据库操作"></a>执行数据库操作</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SqlSession 调用Executor执行数据库操作&amp;&amp;生成具体SQL指令。</p>
</div>
<div class="paragraph">
<p>例如`insert`方法:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="nc">String</span> <span class="n">statement</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">parameter</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nf">update</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="nc">String</span> <span class="n">statement</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">parameter</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">dirty</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="nc">MappedStatement</span> <span class="n">ms</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getMappedStatement</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">executor</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">ms</span><span class="o">,</span> <span class="n">wrapCollection</span><span class="o">(</span><span class="n">parameter</span><span class="o">));</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="nc">ExceptionFactory</span><span class="o">.</span><span class="na">wrapException</span><span class="o">(</span><span class="s">"Error updating database.  Cause: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="nc">ErrorContext</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">reset</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从配置中获取`MappedStatement`（使用mapper配置生成的sql映射对象），将插入的数据对象封装成集合（<code>wrapCollection()</code>），然后使用sqlsesion的executor执行update操作。</p>
</div>
<div class="paragraph">
<p>BaseExecutor的update方法如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="nc">MappedStatement</span> <span class="n">ms</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">parameter</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
  <span class="nc">ErrorContext</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">resource</span><span class="o">(</span><span class="n">ms</span><span class="o">.</span><span class="na">getResource</span><span class="o">()).</span><span class="na">activity</span><span class="o">(</span><span class="s">"executing an update"</span><span class="o">).</span><span class="na">object</span><span class="o">(</span><span class="n">ms</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">closed</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExecutorException</span><span class="o">(</span><span class="s">"Executor was closed."</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="n">clearLocalCache</span><span class="o">();</span>
  <span class="k">return</span> <span class="nf">doUpdate</span><span class="o">(</span><span class="n">ms</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>核心在于`doUpdate()<code>，</code> SimpleExecutor.doUpdate()`如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">doUpdate</span><span class="o">(</span><span class="nc">MappedStatement</span> <span class="n">ms</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">parameter</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
  <span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="nc">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">();</span>
    <span class="c1">// 创建StatementHandler对象，从而创建Statement对象</span>
    <span class="nc">StatementHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">newStatementHandler</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ms</span><span class="o">,</span> <span class="n">parameter</span><span class="o">,</span> <span class="nc">RowBounds</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="c1">// 将sql语句和参数绑定并生成SQL指令</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="n">prepareStatement</span><span class="o">(</span><span class="n">handler</span><span class="o">,</span> <span class="n">ms</span><span class="o">.</span><span class="na">getStatementLog</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">handler</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">stmt</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">closeStatement</span><span class="o">(</span><span class="n">stmt</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>依据参数配置创建`StatementHandler`对象，从而创建`Statement`对象，然后执行`Statement`，完成数据库操作。</p>
</div>
<div class="sect2">
<h3 id="_生成statement"><a class="anchor" href="#_生成statement"></a>生成Statement</h3>
<div class="paragraph">
<p><code>StatementHandler`将sql语句和参数绑定，对象生成`Statement</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="code"><pre><span class="kd">private</span> <span class="nc">Statement</span> <span class="nf">prepareStatement</span><span class="o">(</span><span class="nc">StatementHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="nc">Log</span> <span class="n">statementLog</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
  <span class="nc">Statement</span> <span class="n">stmt</span><span class="o">;</span>
  <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">(</span><span class="n">statementLog</span><span class="o">);</span>
  <span class="c1">// 准备Statement</span>
  <span class="n">stmt</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="na">prepare</span><span class="o">(</span><span class="n">connection</span><span class="o">,</span> <span class="n">transaction</span><span class="o">.</span><span class="na">getTimeout</span><span class="o">());</span>
  <span class="c1">// 设置SQL查询中的参数值</span>
  <span class="n">handler</span><span class="o">.</span><span class="na">parameterize</span><span class="o">(</span><span class="n">stmt</span><span class="o">);</span>
  <span class="k">return</span> <span class="n">stmt</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setParameters</span><span class="o">(</span><span class="nc">PreparedStatement</span> <span class="n">ps</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">ErrorContext</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">activity</span><span class="o">(</span><span class="s">"setting parameters"</span><span class="o">).</span><span class="na">object</span><span class="o">(</span><span class="n">mappedStatement</span><span class="o">.</span><span class="na">getParameterMap</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ParameterMapping</span><span class="o">&gt;</span> <span class="n">parameterMappings</span> <span class="o">=</span> <span class="n">boundSql</span><span class="o">.</span><span class="na">getParameterMappings</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">parameterMappings</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterMappings</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="nc">ParameterMapping</span> <span class="n">parameterMapping</span> <span class="o">=</span> <span class="n">parameterMappings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">parameterMapping</span><span class="o">.</span><span class="na">getMode</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">ParameterMode</span><span class="o">.</span><span class="na">OUT</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">value</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">propertyName</span> <span class="o">=</span> <span class="n">parameterMapping</span><span class="o">.</span><span class="na">getProperty</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">boundSql</span><span class="o">.</span><span class="na">hasAdditionalParameter</span><span class="o">(</span><span class="n">propertyName</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// issue #448 ask first for additional params</span>
          <span class="n">value</span> <span class="o">=</span> <span class="n">boundSql</span><span class="o">.</span><span class="na">getAdditionalParameter</span><span class="o">(</span><span class="n">propertyName</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parameterObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">typeHandlerRegistry</span><span class="o">.</span><span class="na">hasTypeHandler</span><span class="o">(</span><span class="n">parameterObject</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span> <span class="o">{</span>
          <span class="n">value</span> <span class="o">=</span> <span class="n">parameterObject</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="nc">MetaObject</span> <span class="n">metaObject</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">newMetaObject</span><span class="o">(</span><span class="n">parameterObject</span><span class="o">);</span>
          <span class="n">value</span> <span class="o">=</span> <span class="n">metaObject</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">propertyName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">TypeHandler</span> <span class="n">typeHandler</span> <span class="o">=</span> <span class="n">parameterMapping</span><span class="o">.</span><span class="na">getTypeHandler</span><span class="o">();</span>
        <span class="nc">JdbcType</span> <span class="n">jdbcType</span> <span class="o">=</span> <span class="n">parameterMapping</span><span class="o">.</span><span class="na">getJdbcType</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">jdbcType</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">jdbcType</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getJdbcTypeForNull</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">typeHandler</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="n">ps</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">jdbcType</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TypeException</span> <span class="o">|</span> <span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">TypeException</span><span class="o">(</span><span class="s">"Could not set parameters for mapping: "</span> <span class="o">+</span> <span class="n">parameterMapping</span> <span class="o">+</span> <span class="s">". Cause: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>获取参数映射列表：<code>boundSql.getParameterMappings()</code>，</p>
</li>
<li>
<p>依次绑定参数和值</p>
</li>
<li>
<p>typeHandler处理java对象和数据库数据类型的映射，生成`PreparedStatement`。</p>
</li>
</ol>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>`ParameterMapping`负责<strong>java对象和jdbc对象的映射</strong>；</p>
</div>
</blockquote>
</div>
<div class="sect3">
<h4 id="_boundsql"><a class="anchor" href="#_boundsql"></a>boundSql</h4>
<div class="paragraph">
<p>要是通过`MappedStatement.getBoundSql()`方法调用获取的:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="nc">BoundSql</span> <span class="nf">getBoundSql</span><span class="o">(</span><span class="nc">Object</span> <span class="n">parameterObject</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 通过SqlSource获取BoundSql对象</span>
  <span class="nc">BoundSql</span> <span class="n">boundSql</span> <span class="o">=</span> <span class="n">sqlSource</span><span class="o">.</span><span class="na">getBoundSql</span><span class="o">(</span><span class="n">parameterObject</span><span class="o">);</span>
  <span class="c1">// 校验当前的sql语句有无绑定parameterMapping属性</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ParameterMapping</span><span class="o">&gt;</span> <span class="n">parameterMappings</span> <span class="o">=</span> <span class="n">boundSql</span><span class="o">.</span><span class="na">getParameterMappings</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">parameterMappings</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">parameterMappings</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">boundSql</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BoundSql</span><span class="o">(</span><span class="n">configuration</span><span class="o">,</span> <span class="n">boundSql</span><span class="o">.</span><span class="na">getSql</span><span class="o">(),</span> <span class="n">parameterMap</span><span class="o">.</span><span class="na">getParameterMappings</span><span class="o">(),</span> <span class="n">parameterObject</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// check for nested result maps in parameter mappings (issue #30)</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">ParameterMapping</span> <span class="n">pm</span> <span class="o">:</span> <span class="n">boundSql</span><span class="o">.</span><span class="na">getParameterMappings</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">rmId</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">getResultMapId</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rmId</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ResultMap</span> <span class="n">rm</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getResultMap</span><span class="o">(</span><span class="n">rmId</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">rm</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">hasNestedResultMaps</span> <span class="o">|=</span> <span class="n">rm</span><span class="o">.</span><span class="na">hasNestedResultMaps</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">boundSql</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>BoundSql语句的解析主要是通过对`#{}`字符的解析，将其替换成`?`。最后均包装成预表达式供`PrepareStatement`调用执行</p>
</li>
<li>
<p><code>#{}`中的key属性以及相应的参数映射，比如`javaType</code>、`jdbcType`等信息均保存至`BoundSql`的`parameterMappings`属性中供最后的`PrepareStatement`赋值使用。</p>
</li>
</ol>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>BoundSql存储mapper中未解析转换的sql &#8594; PreparedStatement所需的所有类型、参数、值。</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_执行statement"><a class="anchor" href="#_执行statement"></a>执行Statement</h3>
<div class="paragraph">
<p>` SimpleExecutor.doUpdate()`生成`PreparedStatment`后，就执行SQL操作，并生成返回值：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="nc">Statement</span> <span class="n">statement</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
  <span class="nc">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="o">(</span><span class="nc">PreparedStatement</span><span class="o">)</span> <span class="n">statement</span><span class="o">;</span>
  <span class="n">ps</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
  <span class="kt">int</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">getUpdateCount</span><span class="o">();</span>
  <span class="nc">Object</span> <span class="n">parameterObject</span> <span class="o">=</span> <span class="n">boundSql</span><span class="o">.</span><span class="na">getParameterObject</span><span class="o">();</span>
  <span class="nc">KeyGenerator</span> <span class="n">keyGenerator</span> <span class="o">=</span> <span class="n">mappedStatement</span><span class="o">.</span><span class="na">getKeyGenerator</span><span class="o">();</span>
  <span class="n">keyGenerator</span><span class="o">.</span><span class="na">processAfter</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="n">mappedStatement</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">);</span>
  <span class="k">return</span> <span class="n">rows</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>此处返回操作成功的记录条数。</p>
</div>
<div class="paragraph">
<p>如果是query操作，返回的是一个`ResultSet`，mybatis将查询结果包装成`ResultSetWrapper`类型，然后一步步对应java类型赋值等。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_事务提交"><a class="anchor" href="#_事务提交"></a>事务提交</h2>
<div class="sectionbody">
<div class="paragraph">
<p>事务提价源码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">force</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 是否提交（判断是提交还是回滚）</span>
      <span class="k">this</span><span class="o">.</span><span class="na">executor</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">isCommitOrRollbackRequired</span><span class="o">(</span><span class="n">force</span><span class="o">));</span>
      <span class="k">this</span><span class="o">.</span><span class="na">dirty</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">var6</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nc">ExceptionFactory</span><span class="o">.</span><span class="na">wrapException</span><span class="o">(</span><span class="s">"Error committing transaction.  Cause: "</span> <span class="o">+</span> <span class="n">var6</span><span class="o">,</span> <span class="n">var6</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="nc">ErrorContext</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">reset</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//关闭自动提交且dirty=false（表示执行sql过程中无异常）</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isCommitOrRollbackRequired</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">force</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">autoCommit</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">dirty</span> <span class="o">||</span> <span class="n">force</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">//BaseExecutor的commit方法</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">required</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">required</span><span class="o">);</span>
  <span class="k">this</span><span class="o">.</span><span class="na">tcm</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="o">}</span>
<span class="c1">//提交事物，清理本地缓存和刷新statement到数据库持久化存储</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">required</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">closed</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExecutorException</span><span class="o">(</span><span class="s">"Cannot commit, transaction is already closed"</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">clearLocalCache</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">flushStatements</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">required</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">transaction</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//最后调用JDBCTransaction的commit方法：</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">connection</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">getAutoCommit</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Committing JDBC Connection ["</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">connection</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="c1">// 提交连接</span>
      <span class="k">this</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>

      </div>

      <footer>
        


        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hgfkeep" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css" integrity="sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js" integrity="sha384-2BKqo+exmr9su6dir+qCw08N2ZKRucY4PrGQPPWU1A7FtlCGjmEGFqXCv5nyM5Ij" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
        ]
      }
    );">
  </script>
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
      <p><div style='padding:2px'><div style='font-weight: bold;'>遇见你是我的幸运-jxn❤️</div><br />感谢阅读，如果有问题请您留言<br /></div><div style=''><img src='https://licensebuttons.net/l/by-nc-sa/3.0/88x31.png'> </div></p>
    
     © 2020
    
       · 
      技术支持 <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
